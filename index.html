<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨çƒé§•ç…§äº’æƒ ç³»çµ± v5.0</title>
    <style>
        :root {
            --status-green: #3cb371; --status-orange: #ffa500; --status-red: #f08080;
            --intl-bg: #d1e3e9; --tw-bg: #e9e2d1; --sidebar-w: 280px;
        }

        body { font-family: "PingFang TC", sans-serif; margin: 0; background: #f4f6f8; color: #333; display: flex; flex-direction: column; }
        
        /* æ¨™é¡Œèˆ‡æ”¶è—è³¼ç‰©è»Š */
        header { background: #2c3e50; color: white; padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header-titles h1 { margin: 0; font-size: 1.8rem; }
        .header-titles h3 { margin: 5px 0 0; font-weight: 300; font-size: 1rem; opacity: 0.8; }

        .fav-cart { position: relative; cursor: pointer; background: #34495e; padding: 8px 18px; border-radius: 25px; transition: 0.2s; }
        .fav-cart:hover { background: #455a64; }
        .fav-count { background: var(--status-red); color: white; border-radius: 50%; padding: 2px 7px; font-size: 0.75rem; margin-left: 5px; }
        .fav-popup { display: none; position: absolute; top: 50px; right: 0; width: 280px; background: white; color: #333; box-shadow: 0 8px 30px rgba(0,0,0,0.3); border-radius: 12px; padding: 15px; z-index: 1001; }
        .fav-item { padding: 8px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }

        .main-layout { display: flex; flex: 1; }
        
        /* å´é‚Šæ¬„ï¼šæ–°å¢æœå°‹æ¡† */
        aside { width: var(--sidebar-w); background: #fff; padding: 20px; border-right: 1px solid #ddd; height: calc(100vh - 80px); position: sticky; top: 80px; overflow-y: auto; }
        .search-box { width: 100%; padding: 10px; border: 2px solid #eee; border-radius: 8px; margin-bottom: 20px; box-sizing: border-box; font-size: 1rem; }
        .search-box:focus { border-color: #3498db; outline: none; }
        
        .filter-group { margin-bottom: 25px; }
        .filter-group h4 { margin: 0 0 12px; border-left: 4px solid #2c3e50; padding-left: 10px; }

        /* Pinterest ä½ˆå±€ */
        .content { flex: 1; padding: 20px; }
        .masonry { column-count: 3; column-gap: 20px; }

        /* åœ‹å®¶ç¾¤çµ„å¡ç‰‡ */
        .country-group { break-inside: avoid; margin-bottom: 25px; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); background: white; border: 1px solid #eee; position: relative; }
        .group-header { background: #fff; padding: 15px; text-align: center; font-size: 1.3rem; font-weight: bold; border-bottom: 1px solid #f0f0f0; }
        
        .sub-card { padding: 15px; border-bottom: 1px dashed rgba(0,0,0,0.1); }
        .sub-card:last-child { border-bottom: none; }
        .type-intl { background: var(--intl-bg); }
        .type-gen { background: var(--tw-bg); }

        .badge { display: inline-block; padding: 3px 12px; border-radius: 20px; color: white; font-size: 0.8rem; font-weight: bold; margin: 10px 0; }
        .bg-success { background: var(--status-green); }
        .bg-warning { background: var(--status-orange); }
        .bg-danger { background: var(--status-red); }

        .fav-btn { position: absolute; top: 12px; right: 12px; border: none; background: rgba(255,255,255,0.9); border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* RWD */
        @media (max-width: 1200px) { .masonry { column-count: 2; } }
        @media (max-width: 768px) { 
            .main-layout { flex-direction: column; } 
            aside { width: 100%; height: auto; position: relative; top: 0; border-right: none; border-bottom: 1px solid #ddd; } 
            .masonry { column-count: 1; } 
        }

        footer { text-align: center; padding: 25px; font-size: 0.85rem; color: #777; background: #fff; border-top: 1px solid #eee; line-height: 1.6; }
    </style>
</head>
<body>

<header>
    <div class="header-titles">
        <h1>å…¨çƒè­·ç…§äº’æƒ æŸ¥è©¢</h1>
        <h3>æŒæœ‰å°ç£ç›£ç†ç«™æ ¸ç™¼çš„ä¸€èˆ¬é§•ç…§ã€åœ‹éš›é§•ç…§</h3>
    </div>
    <div class="fav-cart" onclick="toggleFavPopup()">
        â­ æ”¶è—æ¸…å–® <span class="fav-count" id="fav-count">0</span>
        <div class="fav-popup" id="fav-popup" onclick="event.stopPropagation()">
            <h4 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:8px;">å·²æ”¶è—åœ‹å®¶</h4>
            <div id="fav-list">å°šæœªæ”¶è—é …ç›®</div>
        </div>
    </div>
</header>

<div class="main-layout">
    <aside>
        <input type="text" id="search-input" class="search-box" placeholder="ğŸ” æœå°‹åœ‹å®¶åç¨±..." oninput="render()">
        
        <div class="filter-group">
            <h4>1. é¸æ“‡å€åŸŸ (æ´²åˆ¥)</h4>
            <div id="region-filters"></div>
        </div>

        <div class="filter-group">
            <h4>2. é§•ç…§é¡å‹</h4>
            <label><input type="checkbox" value="intl" class="type-chk" checked> åœ‹éš›é§•ç…§</label><br>
            <label><input type="checkbox" value="gen" class="type-chk" checked> å°ç£ä¸€èˆ¬é§•ç…§</label>
        </div>

        <div class="filter-group">
            <h4>3. äº’æƒ ç‹€æ…‹</h4>
            <label><input type="checkbox" value="success" class="status-chk"> Allowed å¯ä»¥ä½¿ç”¨</label><br>
            <label><input type="checkbox" value="warning" class="status-chk"> Conditional ä¾æ¢ä»¶ä½¿ç”¨</label><br>
            <label><input type="checkbox" value="danger" class="status-chk"> Prohibited ä¸å¯ä½¿ç”¨</label>
        </div>
    </aside>

    <main class="content">
        <div class="masonry" id="card-grid"></div>
    </main>
</div>

<footer>
    è³‡æ–™ä¾†æºï¼šä¸­è¯æ°‘åœ‹äº¤é€šéƒ¨å…¬è·¯ç¸½å±€ | æœ€å¾Œæ›´æ–°ï¼š2026-01-23 <br>
    æœ€æ–°è³‡è¨Šè«‹ç¢ºèªå…¬è·¯ç¸½å±€ç¶²ç«™
</footer>

<script>
    const labels = { success: "Allowed å¯ä»¥ä½¿ç”¨", warning: "Conditional ä¾æ¢ä»¶ä½¿ç”¨", danger: "Prohibited ä¸å¯ä½¿ç”¨" };
    let uniqueData = [];
    let favorites = new Set(JSON.parse(localStorage.getItem('favCountries')) || []);

    async function init() {
        const res = await fetch(`data/data.json?t=${Date.now()}`);
        const raw = await res.json();
        
        // --- å»é‡é‚è¼¯ ---
        const dataMap = new Map();
        raw.forEach(item => { if (item.country) dataMap.set(item.country.trim(), item); });
        uniqueData = Array.from(dataMap.values());

        setupRegionFilters();
        updateFavUI();
        render();
    }

    function setupRegionFilters() {
        const regions = [...new Set(uniqueData.map(d => d.region))];
        const container = document.getElementById('region-filters');
        regions.forEach(r => {
            const el = document.createElement('div');
            el.innerHTML = `<label style="display:block; margin:5px 0;"><input type="checkbox" value="${r}" class="region-chk"> ${r}</label>`;
            el.onchange = render;
            container.appendChild(el);
        });
        document.querySelectorAll('.type-chk, .status-chk').forEach(c => c.onchange = render);
    }

    function render() {
        const keyword = document.getElementById('search-input').value.toLowerCase();
        const activeRegions = Array.from(document.querySelectorAll('.region-chk:checked')).map(c => c.value);
        const activeTypes = Array.from(document.querySelectorAll('.type-chk:checked')).map(c => c.value);
        const activeStatus = Array.from(document.querySelectorAll('.status-chk:checked')).map(c => c.value);

        const grid = document.getElementById('card-grid');
        grid.innerHTML = '';

        const filtered = uniqueData.filter(d => {
            const nameMatch = d.country.toLowerCase().includes(keyword);
            const regMatch = activeRegions.length === 0 || activeRegions.includes(d.region);
            const statusMatch = activeStatus.length === 0 || activeStatus.includes(d.international.status) || activeStatus.includes(d.general.status);
            return nameMatch && regMatch && statusMatch;
        });

        filtered.forEach(item => {
            const showIntl = activeTypes.includes('intl');
            const showGen = activeTypes.includes('gen');
            if (!showIntl && !showGen) return;

            const group = document.createElement('div');
            group.className = 'country-group';
            const isFav = favorites.has(item.country);

            group.innerHTML = `
                <button class="fav-btn" onclick="toggleFav('${item.country}')">${isFav ? 'â¤ï¸' : 'ğŸ¤'}</button>
                <div class="group-header">ğŸ“ ${item.country}</div>
                ${showIntl ? renderSubCard(item.international, 'International åœ‹éš›é§•ç…§', 'intl') : ''}
                ${showGen ? renderSubCard(item.general, 'General å°ç£ä¸€èˆ¬é§•ç…§', 'gen') : ''}
            `;
            grid.appendChild(group);
        });
    }

    function renderSubCard(info, title, type) {
        return `
            <div class="sub-card type-${type}">
                <div style="font-size:0.75rem; font-weight:bold; opacity:0.6;">${title}</div>
                <div class="badge bg-${info.status}">${labels[info.status]}</div>
                <div style="font-size:0.9rem;"><strong>ç•¶åœ°ä½¿ç”¨ï¼š</strong>${info.usage || 'ç„¡'}</div>
                <div style="font-size:0.9rem; margin-top:5px;"><strong>å‚™è¨»ï¼š</strong>${info.notes || 'ç„¡'}</div>
            </div>
        `;
    }

    // æ”¶è—é‚è¼¯ï¼šæŒä¹…åŒ–å­˜å„²æ–¼ localStorage
    function toggleFav(country) {
        if (favorites.has(country)) favorites.delete(country);
        else favorites.add(country);
        localStorage.setItem('favCountries', JSON.stringify(Array.from(favorites)));
        updateFavUI();
        render();
    }

    function updateFavUI() {
        const countEl = document.getElementById('fav-count');
        const listEl = document.getElementById('fav-list');
        countEl.innerText = favorites.size;
        
        if (favorites.size === 0) {
            listEl.innerHTML = '<div style="color:#999; text-align:center; padding:10px;">å°šæœªæ”¶è—ä»»ä½•é …ç›®</div>';
        } else {
            listEl.innerHTML = Array.from(favorites).map(name => `
                <div class="fav-item">
                    <span>ğŸ“ ${name}</span>
                    <button onclick="toggleFav('${name}')" style="border:none; background:none; cursor:pointer; color:#e74c3c;">âœ•</button>
                </div>
            `).join('');
        }
    }

    function toggleFavPopup() {
        const p = document.getElementById('fav-popup');
        p.style.display = p.style.display === 'block' ? 'none' : 'block';
    }

    // é»æ“Šå¤–éƒ¨é—œé–‰å½ˆçª—
    window.onclick = (e) => { if (!e.target.closest('.fav-cart')) document.getElementById('fav-popup').style.display = 'none'; }

    init();
</script>
</body>
</html>
